name: Build Raspberry Pi Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggers

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build-pi:
    name: Build for Raspberry Pi
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - armv7-unknown-linux-gnueabihf  # Pi 3/4 32-bit (most compatible)
          - aarch64-unknown-linux-gnu       # Pi 4/5 64-bit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Cross-compile for ${{ matrix.target }}
      run: ./scripts/cross-compile-pi.sh ${{ matrix.target }}

    - name: Create deployment package
      run: ./scripts/create-pi-package.sh ${{ matrix.target }}

    - name: Get package info
      id: package_info
      run: |
        # Extract architecture name
        ARCH=$(echo "${{ matrix.target }}" | cut -d'-' -f1)
        # Get version from Cargo.toml
        VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
        # Construct package name
        PACKAGE_NAME="lymons-${VERSION}-pcp-${ARCH}.tgz"
        echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "arch=${ARCH}" >> $GITHUB_OUTPUT

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: lymons-pcp-${{ steps.package_info.outputs.arch }}
        path: lymons-*-pcp-${{ steps.package_info.outputs.arch }}.tgz
        retention-days: 30

    - name: Create release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: lymons-*-pcp-${{ steps.package_info.outputs.arch }}.tgz
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-binaries:
    name: Publish to Binaries Branch
    runs-on: ubuntu-latest
    needs: build-pi
    if: success() && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download armv7 artifact
      uses: actions/download-artifact@v4
      with:
        name: lymons-pcp-armv7
        path: ./artifacts/armv7

    - name: Download aarch64 artifact
      uses: actions/download-artifact@v4
      with:
        name: lymons-pcp-aarch64
        path: ./artifacts/aarch64

    - name: Get version
      id: version
      run: |
        VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

    - name: Publish to binaries branch
      run: |
        # Configure git with token authentication
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

        # Fetch binaries branch (or create if doesn't exist)
        git fetch origin binaries:binaries 2>/dev/null || git checkout --orphan binaries

        # Switch to binaries branch
        git checkout binaries 2>/dev/null || true

        # Clean working directory but keep .git
        git rm -rf . 2>/dev/null || true

        # Create directory structure
        mkdir -p latest armv7 aarch64

        # Copy armv7 files
        cp artifacts/armv7/lymons-${{ steps.version.outputs.version }}-pcp-armv7.tgz armv7/
        cp artifacts/armv7/lymons-${{ steps.version.outputs.version }}-pcp-armv7.tgz latest/lymons-latest-pcp-armv7.tgz

        # Copy aarch64 files
        cp artifacts/aarch64/lymons-${{ steps.version.outputs.version }}-pcp-aarch64.tgz aarch64/
        cp artifacts/aarch64/lymons-${{ steps.version.outputs.version }}-pcp-aarch64.tgz latest/lymons-latest-pcp-aarch64.tgz

        # Create README
        cat > README.md << 'EOF'
        # LyMonS Raspberry Pi Binaries

        Pre-compiled binaries for Raspberry Pi (TinyCore Linux / PiCorePlayer).

        ## Download Latest

        - **32-bit (armv7)** - Raspberry Pi 3, 4, Zero 2 W: [lymons-latest-pcp-armv7.tgz](latest/lymons-latest-pcp-armv7.tgz)
        - **64-bit (aarch64)** - Raspberry Pi 4, 5, 400: [lymons-latest-pcp-aarch64.tgz](latest/lymons-latest-pcp-aarch64.tgz)

        ## Installation

        1. Download the appropriate package for your Pi
        2. Extract: `tar xzf lymons-latest-pcp-*.tgz`
        3. Install: `cd lymons-*-pcp-* && sudo ./install.sh`
        4. Configure: `sudo nano /etc/lymons/lymons.yaml`

        ## Versioned Builds

        See the `armv7/` and `aarch64/` directories for specific versions.

        ---
        *Built automatically by GitHub Actions*
        EOF

        # Add and commit
        git add .
        git commit -m "Update binaries: v${{ steps.version.outputs.version }}"

        # Push to binaries branch
        git push origin binaries

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-pi, publish-binaries]
    if: always()
    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.build-pi.result }}" == "success" ]; then
          echo "✅ All Raspberry Pi builds completed successfully!"
          if [ "${{ needs.publish-binaries.result }}" == "success" ]; then
            echo "✅ Binaries published to binaries branch!"
          fi
        else
          echo "❌ Some builds failed"
          exit 1
        fi
