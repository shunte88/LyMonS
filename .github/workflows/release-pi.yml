name: Build Raspberry Pi Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual triggers

env:
  CARGO_TERM_COLOR: always

jobs:
  build-pi:
    name: Build for Raspberry Pi
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - armv7-unknown-linux-gnueabihf  # Pi 3/4 32-bit (most compatible)
          - aarch64-unknown-linux-gnu       # Pi 4/5 64-bit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

    - name: Cross-compile for ${{ matrix.target }}
      run: ./scripts/cross-compile-pi.sh ${{ matrix.target }}

    - name: Create deployment package
      run: ./scripts/create-pi-package.sh ${{ matrix.target }}

    - name: Get package info
      id: package_info
      run: |
        # Extract architecture name
        ARCH=$(echo "${{ matrix.target }}" | cut -d'-' -f1)
        # Get version from Cargo.toml
        VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
        # Construct package name
        PACKAGE_NAME="lymons-${VERSION}-pcp-${ARCH}.tgz"
        echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "arch=${ARCH}" >> $GITHUB_OUTPUT

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: lymons-pcp-${{ steps.package_info.outputs.arch }}
        path: lymons-*-pcp-${{ steps.package_info.outputs.arch }}.tgz
        retention-days: 30

    - name: Create release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: lymons-*-pcp-${{ steps.package_info.outputs.arch }}.tgz
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build-pi
    if: always()
    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.build-pi.result }}" == "success" ]; then
          echo "✅ All Raspberry Pi builds completed successfully!"
        else
          echo "❌ Some builds failed"
          exit 1
        fi
